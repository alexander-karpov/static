<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="simplepeer.min.js"></script>
</head>

<body>
    <script>
        const config = {
            channelConfig: { ordered: false },
            config: {
                iceServers: [
                    {
                        urls: "stun:openrelay.metered.ca:80",
                    },
                    {
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject",
                    },
                    {
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject",
                    },
                    {
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject",
                    },
                ]
            },
            trickle: false
        };

        const socket = new WebSocket('wss://ee4a-2a02-6bf-fff0-500-4423-2006-4d7c-9a14.eu.ngrok.io');
        let p;

        socket.onmessage = (({ data }) => {
            const action = JSON.parse(data.toString('utf8'));

            console.log('message', action);

            if (action.type === 'start') {
                p = new SimplePeer({
                    initiator: true,
                    ...config
                });

                p.on('signal', data => {
                    socket.send(JSON.stringify({
                        type: 'offer',
                        signal: data
                    }));
                });

                p.on('error', err => {
                    console.error(err.code);
                    throw err;
                });

                p.on('connect', () => {
                    // wait for 'connect' event before using the data channel
                    alert('Connected');
                    socket.close(0);
                });

                return;
            }

            if (action.type === 'offer') {
                p = new SimplePeer({
                    initiator: false,
                    ...config
                });

                if (!action.signal) {
                    throw new Error('В сообщении offer не передан сигнал');
                }

                p.signal(action.signal);

                p.on('signal', data => {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        signal: data
                    }));
                });

                p.on('connect', () => {
                    // wait for 'connect' event before using the data channel
                    alert('Connected');
                    socket.close(0);
                })

                p.on('error', err => {
                    console.error(err.code);
                    throw err;
                });

                return;
            }

            if (action.type === 'answer') {
                p.signal(action.signal);
                return;
            }

            throw new Error('Socket action type is unknown');
        });
    </script>

</body>

</html>
